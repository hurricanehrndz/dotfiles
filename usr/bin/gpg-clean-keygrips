#!/bin/bash

if [[ -z "$(pgrep gpg-agent)" ]]; then
  exit 0
fi

hardware_keygrip_keys=($(gpg --with-keygrip -K --no-tty | grep -A 1 "ssb" | grep Keygrip | sed -n "s/.*=\s\+\(.*\)/\1/p" | tr '\n' ' '))
gpg-connect-agent "SCD BYE" /bye &> /dev/null
gpg-connect-agent "SCD KILLSCD" /bye &> /dev/null

count=0
while IFS= read -r keygrip; do
  if [[ " ${hardware_keygrip_keys[@]} " =~ " ${keygrip} " ]]; then
    echo "Removing keygrip : ${keygrip}.key"
    rm ~/.gnupg/private-keys-v1.d/${keygrip}.key
    count=$((count + 1))
  fi
done < <(ls -1 ~/.gnupg/private-keys-v1.d | sed "s/.key//")

if [[ $count -eq 0 ]]; then
  echo "No keygrips removed."
fi

# reload keys
if [[ -n "$(pgrep gpg-agent)" ]]; then
  echo "Reload private-keys..." | tee
  echo RELOADAGENT | gpg-connect-agent &> /dev/null
  # wait for gpg-agent to reload
  sleep 2
  gpg --card-status --no-tty &> /dev/null
fi
echo "Done!"
exit 0
