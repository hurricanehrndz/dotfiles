# vim:set ft=sh sw=2 sts=2 st=2 et:
#
# connects bt headphones
#
# Authors:
#   HurricaneHrndz <carlos@techbyte.ca>
#

# sony headset
headsets=("00:18:09:21:6B:C8" "00:00:01:00:46:FC" "34:DF:2A:1F:D7:CB")
mac_add="dev_${headset//:/_}"
name=$(basename $0)

usage(){
  echo "Usage: $name {start|stop|status}"
}

hci_dev=$(dbus-send --dest=org.bluez --system --print-reply / \
  org.freedesktop.DBus.ObjectManager.GetManagedObjects | \
  sed -n s%'\s\+object\spath\s"\(/org.*hci.\)"$'%"\1"%p | grep -v "variant")

get_mac_add() {
  headset=$1
  mac_add="dev_${headset//:/_}"
  echo "$mac_add"
}

connected()
{
  mac_add="$1"
  local connected_devs=$(dbus-send --system --dest=org.bluez --type=method_call \
    --print-reply $hci_dev/$mac_add org.freedesktop.DBus.Properties.Get \
    string:org.bluez.Device1 string:Connected 2> /dev/null | grep -c "true")
  if [[ $connected_devs -gt 0 ]]; then
    return 0
  else
    return 1
  fi
}

start()
{
  # power on bluetooth device
  dbus-send --system --dest=org.bluez --type=method_call \
    --print-reply $hci_dev \
    org.freedesktop.DBus.Properties.Set \
    string:org.bluez.Adapter1 string:Powered variant:boolean:true &> /dev/null
  local connected_devs=0
  for headset in "${headsets[@]}"; do
    mac_add=$(get_mac_add $headset)
    dbus-send --system --dest=org.bluez --type=method_call \
      --print-reply \
      $hci_dev/$mac_add org.bluez.Device1.Connect &> /dev/null
    if ( connected $mac_add ); then
      notify-send -u normal -i audio-headset  "Bluetooth" "Headphones connected!"
      return 0
    fi
  done
}

stop()
{
  local connected_devs=0
  for headset in "${headsets[@]}"; do
    mac_add=$(get_mac_add $headset)
    dbus-send --system --dest=org.bluez --type=method_call \
      --print-reply $hci_dev/$mac_add org.bluez.Device1.Disconnect &> /dev/null
    if ( connected $mac_add ); then
      connected_devs=$((connected_devs + 1))
    fi
  done
  if [[ $connected_devs -eq 0 ]]; then
    notify-send -u normal -i audio-headset  "Bluetooth" "Headphones disconnected!"
  fi
  dbus-send --system --dest=org.bluez --type=method_call \
    --print-reply $hci_dev \
    org.freedesktop.DBus.Properties.Set \
    string:org.bluez.Adapter1 string:Powered variant:boolean:false &> /dev/null
}

status()
{
  local connected_devs=0
  for headset in "${headsets[@]}"; do
    mac_add=$(get_mac_add $headset)
    if ( connected $mac_add ); then
      connected_devs=$((connected_devs + 1))
    fi
  done
  if [[ $connected_devs -gt 0 ]]; then
    echo "Headphones connected!"
  else
    echo "Headphones not connected!"
  fi
}

if [[ $# -ne  1 ]]; then
  usage
  return 1
fi

case "$1" in
  start)
    start
    status
    ;;
  stop)
    stop
    ;;
  status)
    status
    ;;
  *)
    usage
    ;;
esac
